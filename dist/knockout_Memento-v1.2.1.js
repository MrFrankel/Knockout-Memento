/*! knockout_Memento 2014-08-08 */
ko.msf=function(){var a=ko.observableArray([]),b=function(){return a()},c=function(){a().forEach(function(a){a.reInit()})},d=function(){a().forEach(function(a){a.clearForGc()}),a.removeAll()},e=function(b){var c=new ko.msf.mStack(b);return a.push(c),c},f=function(b){var c=a.indexOf(b);return-1==c?!1:(b.clearForGc(),a.splice(c,1),!0)},g=function(){return a().length?a()[0]:e()},h=function(){return a().length>0?a()[a().length-1]:void 0},i=ko.computed(function(){return a().some(function(a){return a.isDirty()})});return{getStacks:b,killStack:f,purgeStacks:d,clearStacks:c,getDefaultStack:g,getLastStack:h,createStack:e,isDirty:i}}(),ko.msf.mStack=function(a){a=a||{},a={stackLimit:a.stackLimit||50,discardUndefined:a.discardUndefined||!1};var b=ko.msf.ErrorHandler,c=!0,d=[],e=[],f=[],g=[],h=0,i=!1,j=ko.observable(!1),k=function(b,c){b.length>a.stackLimit&&b.shift(),b.push(c.splice(0)),c.length=0},l=function(a,b){var c=a.pop();if(!c)return!1;var f=[];return c.forEach(function(a){f.unshift(a.duplicate()),i=!0,a.trigger(d),i=!1}.bind(this)),b.push(f.splice(0)),f.length=0,j(e.length>0),!0},m=function(){e.length=0,f.length=0};this.clearForGc=function(){d.length=0,e.length=0,f.length=0,g.length=0;for(var a in this)this.hasOwnProperty(a)&&(this[a]=void 0);return!0},this.reInit=function(){m(),g.length=0,i=!1,h=!1,j(!1)},this.isUpdating=function(){return i},this.stopListening=function(){c=!1},this.resumeListening=function(){c=!0},this.subscribeTo=function(a){if(!a instanceof Function)return b.throwError("Subscriber is not an instance of Function"),!1;d.push(a);var c={};return c.dispose=function(){var b=d.indexOf(a);d.splice(b,1)},c},this.stackChange=function(d,l,m){if(i||!c)return!1;if(!l)return b.throwError("No subject has been passed to register on"),!1;if(a.discardUndefined&&void 0===m)return!1;f.length=0;var n=new ko.msf.mStack.Memento(d,l,m);return g.push(n),h>0?!0:(k(e,g),j(!0),!0)},this.triggerUndo=function(){return l(e,f)},this.triggerRedo=function(){return l(f,e)},this.startSequencing=function(){h+=1},this.stopSequencing=function(){h-=1,0>h&&(h=0,b.throwError("Sequencing Mode has been stooped but but never started, ignored")),h>0||k(e,g.reverse())},this.hasUndos=function(){return e.length>0},this.hasRedos=function(){return f.length>0},this.isDirty=ko.computed(function(){return j()})},ko.extenders.registerToMS=function(a,b){b=b||{};var c=b.stack||ko.msf.getDefaultStack(),d=ko.computed({read:function(){return a()},write:function(b){d.dontReg||d.registerCurrentValue(),a(b)}});return d.dontReg=!1,d.stopRegistering=function(){d.dontReg=!0},d.resumeRegistering=function(){d.dontReg=!1},d.registerCurrentValue=function(){d.registerAValue(a())},d.registerAValue=function(a){c.stackChange(b.context,d,a)},d.valueHasMutated=function(){d.notifySubscribers(a)},d},ko.extenders.registerArrayToMS=function(a,b){b=b||{};var c=b.stack||ko.msf.getDefaultStack();return a.subscribe(function(b){a.dontReg||a.registerAValue(b)},this,"beforeChange"),a.dontReg=!1,a.stopRegistering=function(){result.dontReg=!0},a.resumeRegistering=function(){result.dontReg=!1},a.registerCurrentValue=function(){result.registerAValue(a())},a.registerAValue=function(d){var e=d.slice(0);c.stackChange(b.context,a,e)},a},ko.registerdObservable=function(a,b){var c=ko.observable(a);b=b||{};var d=b.stack||ko.msf.getDefaultStack(),e=ko.computed({read:function(){return c()},write:function(a){e.dontReg||e.registerCurrentValue(),c(a)}});return e.stopRegistering=function(){e.dontReg=!0},e.resumeRegistering=function(){e.dontReg=!1},e.registerCurrentValue=function(){e.registerAValue(c())},e.registerAValue=function(a){d.stackChange(b.context,e,a)},e.valueHasMutated=function(){e.notifySubscribers(c)},e},ko.msf.mStack.Memento=function(a,b,c){var d=a||function(){},e=function(a){a instanceof Array&&a.forEach(function(a){a({context:d,subject:b,value:c})})};this.trigger=function(a){return e(a),b(c),this.clearForGc()},this.duplicate=function(){return new ko.msf.mStack.Memento(d,b,b())},this.clearForGc=function(){b=void 0,c=void 0,d=void 0;for(var a in this)this.hasOwnProperty(a)&&(this[a]=void 0);return!0}},ko.msf.ErrorHandler=function(){var a=function(a){var b=new Error;throw b.message="ko.Memento Error: "+a,b};return{throwError:a}}();